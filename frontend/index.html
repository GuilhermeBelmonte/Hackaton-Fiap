<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerador de Avalia√ß√µes - MVP</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #020617, #0f172a);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .container {
      width: 100%;
      max-width: 820px;
      background: #020617;
      border-radius: 14px;
      padding: 28px;
      box-shadow: 0 20px 40px rgba(0,0,0,.6);
      border: 1px solid #1e293b;
    }
    h1 { margin: 0 0 18px; font-size: 1.7rem; }
    h2 { margin: 0 0 12px; font-size: 1.2rem; color: #cbd5e1; font-weight: 600; }
    .muted { color: #94a3b8; font-size: .9rem; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 220px; }
    input, select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #1e293b;
      background: #0b1220;
      color: #e5e7eb;
      font-size: 1rem;
      outline: none;
    }
    input::placeholder { color: #64748b; }
    .btn {
      padding: 12px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 1rem;
      transition: transform .15s ease, box-shadow .15s ease;
      width: 100%;
    }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(37,99,235,.35);
    }
    .btn-secondary {
      background: linear-gradient(135deg, #059669, #047857);
      color: #fff;
      margin-top: 8px;
    }
    .btn-secondary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(5,150,105,.35);
    }
    .btn-ghost {
      background: transparent;
      color: #93c5fd;
      border: 1px solid #1e40af;
      width: auto;
      padding: 10px 12px;
    }
    .btn-link {
      background: transparent;
      color: #60a5fa;
      text-decoration: underline;
      padding: 8px;
      font-weight: 400;
      font-size: 0.9rem;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }
    .card {
      margin-top: 16px;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid #1e293b;
      background: #0b1220;
    }
    .result {
      margin-top: 16px;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid #1e293b;
      background: #0b1220;
    }
    .question { margin: 10px 0; }
    hr { border: none; border-top: 1px solid #1e293b; margin: 16px 0; }
    .pdf-links { display: flex; gap: 10px; flex-wrap: wrap; }
    .pdf-links a {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #2563eb;
      color: #93c5fd;
      text-decoration: none;
      background: #081024;
      transition: transform .15s ease, background .15s ease;
    }
    .pdf-links a:hover { transform: translateY(-1px); background: #0f1b3a; }
    .error { color: #fecaca; background: rgba(239,68,68,.12); border: 1px solid rgba(239,68,68,.35); padding: 10px 12px; border-radius: 10px; }
    .success { color: #86efac; background: rgba(34,197,94,.12); border: 1px solid rgba(34,197,94,.35); padding: 10px 12px; border-radius: 10px; }
    .hidden { display: none; }
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-badge {
      background: #1e293b;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      color: #cbd5e1;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div>
        <h1>üß† Gerador de Avalia√ß√µes</h1>
        <div class="muted">MVP Hackathon ‚Ä¢ Sistema com autentica√ß√£o</div>
      </div>
      <div id="userInfo" class="user-info hidden">
        <span id="userBadge" class="user-badge"></span>
        <button id="logoutBtn" class="btn btn-ghost" onclick="logout()">Sair</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginView" class="card">
      <h2>Entrar</h2>
      <div class="muted">Use seu email e senha para acessar o sistema.</div>
      <div style="height:12px"></div>

      <div class="row">
        <div class="col">
          <input id="loginEmail" placeholder="Email" type="email" />
        </div>
        <div class="col">
          <input id="loginPassword" type="password" placeholder="Senha" />
        </div>
      </div>

      <div style="height:12px"></div>
      <button class="btn btn-primary" onclick="login()">Entrar</button>
      
      <div style="height:8px"></div>
      <button class="btn btn-link" onclick="showRegister()">N√£o tem conta? Criar nova conta</button>

      <div style="height:12px"></div>
      <div id="loginError" class="error hidden"></div>
    </div>

    <!-- REGISTRO -->
    <div id="registerView" class="card hidden">
      <h2>Criar Nova Conta</h2>
      <div class="muted">Preencha os dados para criar sua conta.</div>
      <div style="height:12px"></div>

      <div class="row">
        <div class="col">
          <input id="registerName" placeholder="Nome (opcional)" />
        </div>
      </div>

      <div style="height:8px"></div>

      <div class="row">
        <div class="col">
          <input id="registerEmail" placeholder="Email" type="email" />
        </div>
        <div class="col">
          <input id="registerPassword" type="password" placeholder="Senha (m√≠n. 6 caracteres)" />
        </div>
      </div>

      <div style="height:12px"></div>
      <button class="btn btn-secondary" onclick="register()">Criar Conta</button>
      
      <div style="height:8px"></div>
      <button class="btn btn-link" onclick="showLogin()">J√° tem conta? Fazer login</button>

      <div style="height:12px"></div>
      <div id="registerError" class="error hidden"></div>
      <div id="registerSuccess" class="success hidden"></div>
    </div>

    <!-- APP -->
    <div id="appView" class="card hidden">
      <h2>Criar avalia√ß√£o</h2>
      <div class="muted">Preencha os dados e gere PDFs (Aluno + Professor).</div>
      <div style="height:12px"></div>

      <div class="row">
        <div class="col">
          <input id="topic" placeholder="Tema (ex: TypeScript, Geografia, POO)" />
        </div>
        <div class="col">
          <select id="level">
            <option value="iniciante">Iniciante</option>
            <option value="intermediario">Intermedi√°rio</option>
            <option value="avancado">Avan√ßado</option>
          </select>
        </div>
        <div class="col">
          <input id="amount" type="number" min="1" max="20" value="5" placeholder="N¬∫ de quest√µes" />
        </div>
      </div>

      <div style="height:12px"></div>
      <button id="generateBtn" class="btn btn-primary" onclick="generate()">Gerar avalia√ß√£o</button>

      <div id="result" class="result">Ap√≥s gerar, o resultado aparece aqui.</div>
    </div>
  </div>

  <script>
    const TOKEN_KEY = 'hackathon_token'
    const USER_KEY = 'hackathon_user'

    function getToken() {
      return localStorage.getItem(TOKEN_KEY)
    }

    function setToken(token) {
      localStorage.setItem(TOKEN_KEY, token)
    }

    function clearToken() {
      localStorage.removeItem(TOKEN_KEY)
      localStorage.removeItem(USER_KEY)
    }

    function setUser(user) {
      localStorage.setItem(USER_KEY, JSON.stringify(user))
    }

    function getUser() {
      const userData = localStorage.getItem(USER_KEY)
      return userData ? JSON.parse(userData) : null
    }

    function showLogin() {
      document.getElementById('loginView').classList.remove('hidden')
      document.getElementById('registerView').classList.add('hidden')
      document.getElementById('appView').classList.add('hidden')
      document.getElementById('userInfo').classList.add('hidden')
      
      // Limpa erros
      document.getElementById('loginError').classList.add('hidden')
      document.getElementById('loginError').textContent = ''
    }

    function showRegister() {
      document.getElementById('loginView').classList.add('hidden')
      document.getElementById('registerView').classList.remove('hidden')
      document.getElementById('appView').classList.add('hidden')
      document.getElementById('userInfo').classList.add('hidden')
      
      // Limpa mensagens
      document.getElementById('registerError').classList.add('hidden')
      document.getElementById('registerSuccess').classList.add('hidden')
      document.getElementById('registerError').textContent = ''
      document.getElementById('registerSuccess').textContent = ''
    }

    function showApp() {
      document.getElementById('loginView').classList.add('hidden')
      document.getElementById('registerView').classList.add('hidden')
      document.getElementById('appView').classList.remove('hidden')
      document.getElementById('userInfo').classList.remove('hidden')
      
      // Mostra nome do usu√°rio
      const user = getUser()
      if (user) {
        document.getElementById('userBadge').textContent = user.name || user.email
      }
    }

    function logout() {
      clearToken()
      showLogin()
    }

    // ao carregar, decide tela
    (function init() {
      const token = getToken()
      if (token) showApp()
      else showLogin()
    })()

    async function login() {
      const email = document.getElementById('loginEmail').value.trim()
      const password = document.getElementById('loginPassword').value.trim()
      const errBox = document.getElementById('loginError')

      errBox.classList.add('hidden')
      errBox.textContent = ''

      if (!email || !password) {
        errBox.textContent = 'Preencha email e senha'
        errBox.classList.remove('hidden')
        return
      }

      try {
        const res = await fetch('/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        })

        const data = await res.json()

        if (!res.ok) {
          errBox.textContent = data.error || `Erro ${res.status}`
          errBox.classList.remove('hidden')
          return
        }

        if (!data.token) {
          errBox.textContent = 'Login n√£o retornou token.'
          errBox.classList.remove('hidden')
          return
        }

        setToken(data.token)
        setUser(data.user)
        showApp()

      } catch (e) {
        console.error(e)
        errBox.textContent = 'Falha no login. Veja o console.'
        errBox.classList.remove('hidden')
      }
    }

    async function register() {
      const name = document.getElementById('registerName').value.trim()
      const email = document.getElementById('registerEmail').value.trim()
      const password = document.getElementById('registerPassword').value.trim()
      const errBox = document.getElementById('registerError')
      const successBox = document.getElementById('registerSuccess')

      errBox.classList.add('hidden')
      successBox.classList.add('hidden')
      errBox.textContent = ''
      successBox.textContent = ''

      if (!email || !password) {
        errBox.textContent = 'Preencha email e senha'
        errBox.classList.remove('hidden')
        return
      }

      if (password.length < 6) {
        errBox.textContent = 'Senha deve ter no m√≠nimo 6 caracteres'
        errBox.classList.remove('hidden')
        return
      }

      try {
        const res = await fetch('/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, name })
        })

        const data = await res.json()

        if (!res.ok) {
          errBox.textContent = data.error || `Erro ${res.status}`
          errBox.classList.remove('hidden')
          return
        }

        if (!data.token) {
          errBox.textContent = 'Registro n√£o retornou token.'
          errBox.classList.remove('hidden')
          return
        }

        // Sucesso! Faz login automaticamente
        setToken(data.token)
        setUser(data.user)
        
        successBox.textContent = '‚úì Conta criada com sucesso! Redirecionando...'
        successBox.classList.remove('hidden')
        
        setTimeout(() => showApp(), 1500)

      } catch (e) {
        console.error(e)
        errBox.textContent = 'Falha no registro. Veja o console.'
        errBox.classList.remove('hidden')
      }
    }

    async function generate() {
      const token = getToken()
      if (!token) {
        showLogin()
        return
      }

      const btn = document.getElementById('generateBtn')
      btn.disabled = true
      const oldText = btn.textContent
      btn.textContent = 'Gerando...'

      const result = document.getElementById('result')
      result.textContent = 'Gerando avalia√ß√£o...'

      try {
        const topic = document.getElementById('topic').value.trim()
        const level = document.getElementById('level').value
        const amount = Number(document.getElementById('amount').value)

        if (!topic) {
          result.textContent = 'Por favor, preencha o tema da avalia√ß√£o'
          return
        }

        const res = await fetch('/questions/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ topic, level, amount })
        })

        if (res.status === 401) {
          clearToken()
          showLogin()
          return
        }

        const data = await res.json()

        if (!res.ok) {
          result.textContent = data.error || `Erro ${res.status}`
          return
        }

        renderAssessment(data.assessment ?? data, data.pdfs)

      } catch (e) {
        console.error(e)
        result.textContent = 'Erro ao gerar avalia√ß√£o. Veja o console.'
      } finally {
        btn.disabled = false
        btn.textContent = oldText
      }
    }

    function renderAssessment(assessment, pdfs) {
      const result = document.getElementById('result')
      result.innerHTML = ''

      const title = document.createElement('h2')
      title.textContent = assessment.title ?? 'Avalia√ß√£o'
      result.appendChild(title)

      const meta = document.createElement('div')
      meta.className = 'muted'
      meta.textContent = `N√≠vel: ${assessment.level} ‚Ä¢ Tempo total: ${assessment.totalTime} min`
      result.appendChild(meta)

      const questions = assessment.questions ?? []
      questions.forEach((q, i) => {
        const div = document.createElement('div')
        div.className = 'question'
        div.textContent = `${i + 1}. ${q.statement}`
        result.appendChild(div)
      })

      if (pdfs?.student?.fileName || pdfs?.teacher?.fileName) {
        result.appendChild(document.createElement('hr'))
        const links = document.createElement('div')
        links.className = 'pdf-links'

        if (pdfs.student?.fileName) {
          const a = document.createElement('a')
          a.href = `/files/${pdfs.student.fileName}`
          a.target = '_blank'
          a.rel = 'noreferrer'
          a.textContent = 'üìÑ PDF do Aluno'
          links.appendChild(a)
        }

        if (pdfs.teacher?.fileName) {
          const a = document.createElement('a')
          a.href = `/files/${pdfs.teacher.fileName}`
          a.target = '_blank'
          a.rel = 'noreferrer'
          a.textContent = 'üßë‚Äçüè´ PDF do Professor'
          links.appendChild(a)
        }

        result.appendChild(links)
      }
    }

    // Permite login com Enter
    document.getElementById('loginPassword')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login()
    })

    document.getElementById('registerPassword')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') register()
    })
  </script>
</body>
</html>
